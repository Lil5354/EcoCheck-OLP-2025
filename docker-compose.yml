# MIT License
# Copyright (c) 2025 Lil5354
# EcoCheck-OLP-2025 Docker Compose Configuration
# FIWARE-based Environmental Monitoring System

services:
  # FIWARE Orion-LD Context Broker (NGSI-LD)
  orion-ld:
    image: fiware/orion-ld:latest
    hostname: orion-ld
    container_name: ecocheck-orion-ld
    depends_on:
      mongo-db:
        condition: service_healthy
    ports:
      - "1026:1026"
    environment:
      - ORIONLD_MONGO_HOST=mongo-db:27017
    command: -dbURI mongodb://ecocheck-mongodb:27017/orion -logLevel DEBUG -dbTimeout 30000
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:1026/version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: on-failure
    links:
      - mongo-db:ecocheck-mongodb
    networks:
      - ecocheck-network

  # MongoDB for Orion Context Broker
  mongo-db:
    image: mongo:4.4
    hostname: mongo-db
    container_name: ecocheck-mongodb
    command: --bind_ip_all
    ports:
      - "27017:27017"
    volumes:
      - mongo-db-data:/data/db
      - mongo-db-config:/data/configdb
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      ecocheck-network:
        aliases:
          - mongo-db
          - mongodb

  # PostgreSQL for application data
  postgres:
    image: postgres:15-alpine
    container_name: ecocheck-postgres
    environment:
      POSTGRES_DB: ecocheck
      POSTGRES_USER: ecocheck_user
      POSTGRES_PASSWORD: ecocheck_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ecocheck_user -d ecocheck"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ecocheck-network

  # EcoCheck Backend (Node.js)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ecocheck-backend
    depends_on:
      orion-ld:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - ORION_LD_URL=http://orion-ld:1026
      - FIWARE_SERVICE=ecocheck
      - FIWARE_SERVICE_PATH=/hcm
      - DATABASE_URL=postgresql://ecocheck_user:ecocheck_pass@postgres:5432/ecocheck
    volumes:
      - ./backend/src:/app/src:ro
      - ./backend/public:/app/public:ro
    healthcheck:
      test: curl --fail -s http://localhost:3000/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - ecocheck-network

  # Frontend Web Manager (React)
  frontend-web:
    build:
      context: ./frontend-web-manager
      dockerfile: Dockerfile
    container_name: ecocheck-frontend-web
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "3001:80"
    environment:
      - REACT_APP_API_URL=http://localhost:3000/api
    networks:
      - ecocheck-network

volumes:
  mongo-db-data:
  mongo-db-config:
  postgres-data:

networks:
  ecocheck-network:
    driver: bridge
# MIT License
# Copyright (c) 2025 Lil5354
# Render Blueprint Configuration
# Defines PostgreSQL database and web service

# Note: Database must be created manually first in Render Dashboard
# Then link it to the web service using fromDatabase

services:
  # Web Service (Frontend + Backend + Nginx)
  - type: web
    name: ecocheck-web
    env: docker
    dockerfilePath: ./Dockerfile.render
    dockerContext: .
    # No plan specified = Free tier (with limitations: spins down after 15min inactivity)
    envVars:
      # Database connection - will be automatically set by Render from database service
      - key: DATABASE_URL
        fromDatabase:
          name: ecocheck-database
          property: connectionString
      
      # Database connection details (alternative, parsed from DATABASE_URL)
      - key: DB_HOST
        fromDatabase:
          name: ecocheck-database
          property: host
      - key: DB_PORT
        fromDatabase:
          name: ecocheck-database
          property: port
      - key: DB_USER
        fromDatabase:
          name: ecocheck-database
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: ecocheck-database
          property: password
      - key: DB_NAME
        fromDatabase:
          name: ecocheck-database
          property: database
      
      # Application settings
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      
      # Backend settings (optional)
      - key: BACKEND_PORT
        value: 3000
      
      # FIWARE settings (if needed)
      - key: ORION_LD_URL
        value: http://localhost:1026
      - key: FIWARE_SERVICE
        value: ecocheck
      - key: FIWARE_SERVICE_PATH
        value: /hcm
    
    healthCheckPath: /health
    region: singapore # Choose your preferred region
    
    # Pre-deploy command to run migrations (backup option if entrypoint fails)
    # Uncomment if needed:
    # preDeployCommand: cd /app/db && export PGPASSWORD=$DB_PASSWORD && bash ./run_migrations.sh


# Script thi·∫øt l·∫≠p Server Test cho Web v√† Mobile
# EcoCheck OLP 2025

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  EcoCheck - Test Server Setup" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# 1. L·∫•y Local IP
Write-Host "[1/5] L·∫•y Local IP Address..." -ForegroundColor Yellow
$localIP = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object { 
    $_.IPAddress -notlike "127.*" -and 
    $_.IPAddress -notlike "169.254.*" -and
    $_.InterfaceAlias -notlike "*Loopback*"
} | Select-Object -First 1).IPAddress

if (-not $localIP) {
    $localIP = "localhost"
    Write-Host "‚ö†Ô∏è  Kh√¥ng t√¨m th·∫•y Local IP, s·ª≠ d·ª•ng: $localIP" -ForegroundColor Yellow
} else {
    Write-Host "‚úÖ Local IP: $localIP" -ForegroundColor Green
}
Write-Host ""

# 2. Ki·ªÉm tra Docker
Write-Host "[2/5] Ki·ªÉm tra Docker..." -ForegroundColor Yellow
try {
    docker ps | Out-Null
    Write-Host "‚úÖ Docker ƒëang ch·∫°y" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Docker ch∆∞a ch·∫°y! Vui l√≤ng kh·ªüi ƒë·ªông Docker Desktop" -ForegroundColor Red
    exit 1
}
Write-Host ""

# 3. Kh·ªüi ƒë·ªông Services
Write-Host "[3/5] Kh·ªüi ƒë·ªông Docker Services..." -ForegroundColor Yellow
docker compose up -d
Start-Sleep -Seconds 5
Write-Host "‚úÖ Services ƒë√£ kh·ªüi ƒë·ªông" -ForegroundColor Green
Write-Host ""

# 4. Ki·ªÉm tra Backend
Write-Host "[4/5] Ki·ªÉm tra Backend API..." -ForegroundColor Yellow
$maxRetries = 10
$retryCount = 0
$backendReady = $false

while ($retryCount -lt $maxRetries -and -not $backendReady) {
    try {
        $response = Invoke-WebRequest -Uri "http://localhost:3000/health" -TimeoutSec 2 -UseBasicParsing
        if ($response.StatusCode -eq 200) {
            $backendReady = $true
            Write-Host "‚úÖ Backend API ƒëang ch·∫°y" -ForegroundColor Green
        }
    } catch {
        $retryCount++
        Write-Host "   ƒêang ƒë·ª£i backend... ($retryCount/$maxRetries)" -ForegroundColor Gray
        Start-Sleep -Seconds 2
    }
}

if (-not $backendReady) {
    Write-Host "‚ö†Ô∏è  Backend ch∆∞a s·∫µn s√†ng sau $maxRetries l·∫ßn th·ª≠" -ForegroundColor Yellow
}
Write-Host ""

# 5. Hi·ªÉn th·ªã th√¥ng tin k·∫øt n·ªëi
Write-Host "[5/5] Th√¥ng tin k·∫øt n·ªëi:" -ForegroundColor Yellow
Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  üåê WEB PLATFORM" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  Frontend Web:  http://localhost:3001" -ForegroundColor Yellow
Write-Host "  Backend API:   http://localhost:3000" -ForegroundColor Yellow
Write-Host ""

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  üì± MOBILE PLATFORM" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  Android Emulator:" -ForegroundColor Yellow
Write-Host "    Base URL: http://10.0.2.2:3000" -ForegroundColor White
Write-Host ""
Write-Host "  iOS Simulator:" -ForegroundColor Yellow
Write-Host "    Base URL: http://localhost:3000" -ForegroundColor White
Write-Host ""
Write-Host "  Real Device (WiFi):" -ForegroundColor Yellow
Write-Host "    Base URL: http://$localIP:3000" -ForegroundColor White
Write-Host "    (ƒê·∫£m b·∫£o device v√† m√°y t√≠nh c√πng m·∫°ng WiFi)" -ForegroundColor Gray
Write-Host ""

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  üîß TEST ENDPOINTS" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  Health Check:  http://localhost:3000/health" -ForegroundColor Yellow
Write-Host "  API Status:    http://localhost:3000/api/status" -ForegroundColor Yellow
Write-Host ""

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  üìã NEXT STEPS" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  1. Web: M·ªü tr√¨nh duy·ªát ‚Üí http://localhost:3001" -ForegroundColor White
Write-Host "  2. Mobile:" -ForegroundColor White
Write-Host "     - Android: C·∫≠p nh·∫≠t baseUrl trong api_constants.dart" -ForegroundColor Gray
Write-Host "     - iOS: S·ª≠ d·ª•ng localhost:3000" -ForegroundColor Gray
Write-Host "     - Real Device: S·ª≠ d·ª•ng http://$localIP:3000" -ForegroundColor Gray
Write-Host "  3. Test k·∫øt n·ªëi: Ch·∫°y ./test-connection.ps1" -ForegroundColor White
Write-Host ""

# T·∫°o file config cho mobile
$mobileConfig = @"
# Mobile API Configuration
# Generated by setup-test-server.ps1

# Android Emulator
ANDROID_BASE_URL=http://10.0.2.2:3000

# iOS Simulator  
IOS_BASE_URL=http://localhost:3000

# Real Device (Update with your local IP)
REAL_DEVICE_BASE_URL=http://$localIP:3000
"@

$configPath = "mobile-api-config.txt"
$mobileConfig | Out-File -FilePath $configPath -Encoding utf8
Write-Host "‚úÖ ƒê√£ t·∫°o file $configPath" -ForegroundColor Green
Write-Host ""

